/*
 * CONTROLE DE ACESSO v3.0 - OTIMIZADO
 * Reduzido para caber no ESP32
 */

#include <SPI.h>
#include <MFRC522.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <BLEDevice.h>
#include <BLEScan.h>

// CONFIGURAÇÃO - MUDE AQUI
#define WIFI_SSID "SCAP"
#define WIFI_PASS "DENOEMOS"
#define SERVER "http://192.168.0.102:3000"

// PINOS
#define RST 22
#define SS 21
#define LED_R 25
#define LED_G 26
#define BUZ 27
#define REL 14
#define BTN 33

// BLE
#define BLE_N "CartaoAcesso"
#define RS_W -75
#define RS_C -82

enum St{STBY,AUTH,BPAIR,OPER,ALT,OFF};
St st=STBY;

MFRC522 rf(SS,RST);
BLEScan* bs;
BLEClient* bc=nullptr;
BLEAdvertisedDevice* bd=nullptr;

String uid="";
String nom="";
unsigned long tR=0,tI=0,tD=0;
int bL=HIGH,bS=HIGH;

class CB:public BLEAdvertisedDeviceCallbacks{
void onResult(BLEAdvertisedDevice d){}
};

void bp(int n){
for(int i=0;i<n;i++){
digitalWrite(BUZ,HIGH);
delay(100);
digitalWrite(BUZ,LOW);
delay(100);
}
}

bool vo(String u){
if(WiFi.status()!=WL_CONNECTED)return false;

HTTPClient h;
h.begin(String(SERVER)+"/api/validar/"+u);
h.setTimeout(10000);

int c=h.GET();
if(c==200){
String p=h.getString();
StaticJsonDocument<256>d;
if(!deserializeJson(d,p)&&d["autorizado"]){
nom=d["usuario"]["nome"].as<String>();
h.end();
return true;
}
}
h.end();
return false;
}

void le(String e,unsigned long d=0){
if(WiFi.status()!=WL_CONNECTED)return;

HTTPClient h;
h.begin(String(SERVER)+"/api/log");

StaticJsonDocument<200>doc;
doc["timestamp"]=millis()/1000;
doc["machine_id"]="M01";
doc["uid"]=uid;
doc["usuario"]=nom;
doc["evento"]=e;
doc["duracao"]=d;

String j;
serializeJson(doc,j);

h.addHeader("Content-Type","application/json");
h.POST(j);
h.end();
}

bool lb(){
int l=digitalRead(BTN);
if(l!=bL)tD=millis();
if(millis()-tD>50){
if(l!=bS){
bS=l;
if(bS==LOW){
bL=l;
return true;
}
}
}
bL=l;
return false;
}

void setup(){
Serial.begin(115200);
delay(1000);

pinMode(LED_R,OUTPUT);
pinMode(LED_G,OUTPUT);
pinMode(BUZ,OUTPUT);
pinMode(REL,OUTPUT);
pinMode(BTN,INPUT_PULLUP);

digitalWrite(LED_R,LOW);
digitalWrite(LED_G,HIGH);
digitalWrite(REL,LOW);

Serial.println("\n=== CONTROLE ACESSO v3.0 ===\n");

// WiFi
Serial.print("WiFi... ");
WiFi.begin(WIFI_SSID,WIFI_PASS);
int t=0;
while(WiFi.status()!=WL_CONNECTED&&t<30){
delay(500);
Serial.print(".");
t++;
}
if(WiFi.status()==WL_CONNECTED){
Serial.print("OK - ");
Serial.println(WiFi.localIP());
}else{
Serial.println("ERRO");
while(1){bp(3);delay(2000);}
}

// RFID
Serial.print("RFID... ");
SPI.begin();
rf.PCD_Init();
if(rf.PCD_ReadRegister(rf.VersionReg)==0){
Serial.println("ERRO");
while(1){bp(3);delay(1000);}
}
Serial.println("OK");

// BLE
Serial.print("BLE... ");
BLEDevice::init("CA");
esp_ble_tx_power_set(ESP_BLE_PWR_TYPE_ADV,ESP_PWR_LVL_P9);
bs=BLEDevice::getScan();
bs->setAdvertisedDeviceCallbacks(new CB());
bs->setActiveScan(true);
Serial.println("OK");

Serial.println("\n=== PRONTO ===\n");
bp(1);
}

void loop(){
switch(st){
case STBY:lsb();break;
case AUTH:lau();break;
case BPAIR:lbl();break;
case OPER:lop();break;
case ALT:lal();break;
case OFF:lof();break;
}
delay(100);
}

void lsb(){
digitalWrite(LED_R,LOW);
digitalWrite(LED_G,HIGH);
digitalWrite(REL,LOW);

if(!rf.PICC_IsNewCardPresent())return;
if(!rf.PICC_ReadCardSerial())return;

uid="";
for(byte i=0;i<rf.uid.size;i++){
if(rf.uid.uidByte[i]<0x10)uid+="0";
uid+=String(rf.uid.uidByte[i],HEX);
}
uid.toUpperCase();

Serial.print("UID:");
Serial.println(uid);
bp(1);
rf.PICC_HaltA();
st=AUTH;
}

void lau(){
Serial.print("Val... ");

if(!vo(uid)){
Serial.println("NEG");
bp(3);
le("NEG");
delay(2000);
uid="";
st=STBY;
return;
}

Serial.print("OK:");
Serial.println(nom);
le("AUT");
st=BPAIR;
}

void lbl(){
Serial.print("BLE... ");

bd=nullptr;
bs->clearResults();
BLEScanResults*res=bs->start(5,false);

for(int i=0;i<res->getCount();i++){
BLEAdvertisedDevice d=res->getDevice(i);
if(d.getName()==BLE_N){
bd=new BLEAdvertisedDevice(d);
break;
}
}
bs->clearResults();

if(!bd){
Serial.println("NA");
bp(3);
le("BLE_NA");
delay(2000);
st=STBY;
return;
}

bc=BLEDevice::createClient();
if(!bc->connect(bd)){
Serial.println("FL");
bp(3);
delete bc;
bc=nullptr;
st=STBY;
return;
}

digitalWrite(REL,HIGH);
digitalWrite(LED_R,HIGH);
digitalWrite(LED_G,LOW);
bp(2);

tI=millis();
le("LIG");

Serial.println("LIB");
st=OPER;
}

void lop(){
if(lb()){
Serial.println("BTN");
le("BTN");
st=OFF;
return;
}

if(!bc->isConnected()){
st=OFF;
return;
}

if(millis()-tR>=2000){
int r=bc->getRssi();
Serial.print("R:");
Serial.println(r);

if(r<RS_C)st=OFF;
else if(r<RS_W)st=ALT;

tR=millis();
}
}

void lal(){
static unsigned long ta=0;

if(lb()){
ta=0;
le("BTN");
st=OFF;
return;
}

if(!ta){
ta=millis();
Serial.println("ALT");
bp(1);
}

if(millis()%500<250){
digitalWrite(LED_R,LOW);
digitalWrite(LED_G,LOW);
}else{
digitalWrite(LED_R,HIGH);
digitalWrite(LED_G,HIGH);
}

if(!bc->isConnected()){
st=OFF;
return;
}

int r=bc->getRssi();
if(r>RS_W){
ta=0;
digitalWrite(LED_G,LOW);
st=OPER;
}else if(r<RS_C||millis()-ta>10000){
st=OFF;
}
}

void lof(){
Serial.println("OFF");

digitalWrite(REL,LOW);
digitalWrite(LED_R,LOW);
digitalWrite(LED_G,HIGH);
bp(3);

unsigned long d=(millis()-tI)/1000;
le("DES",d);

if(bc&&bc->isConnected())bc->disconnect();

uid="";
nom="";

delay(2000);
st=STBY;
}

/*
 * =====================================================
 *  SISTEMA DE CONTROLE DE ACESSO - MÃQUINA
 *  Hardware: ESP32 WROOM32
 *  Componentes: RC522, W5500, LED RGB, Buzzer, RelÃ©
 *  VersÃ£o: 1.1 - CORRIGIDO
 * =====================================================
 */

#include <SPI.h>
#include <MFRC522.h>
#include <Ethernet.h>
#include <ArduinoJson.h>
#include <BLEDevice.h>
#include <BLEUtils.h>
#include <BLEScan.h>

// ==================== DEFINIÃ‡Ã•ES DE PINOS ====================
// RC522 (RFID)
#define RST_PIN         22
#define SS_RFID_PIN     21
#define MOSI_PIN        23
#define MISO_PIN        19
#define SCK_PIN         18

// W5500 (Ethernet)
#define SS_ETH_PIN      5
#define ETH_RST_PIN     17

// Atuadores
#define LED_RED         25
#define LED_GREEN       26
#define BUZZER          27
#define RELAY           14

// ==================== CONFIGURAÃ‡Ã•ES BLE ====================
#define BLE_DEVICE_NAME "CartaoAcesso"
#define RSSI_THRESHOLD_WARNING  -75    // Ajustado para 2.5m
#define RSSI_THRESHOLD_CRITICAL -82    // Ajustado para 2.5m
#define RSSI_CHECK_INTERVAL     2000

// ==================== CONFIGURAÃ‡Ã•ES ETHERNET ====================
byte mac[] = { 0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0x01 };
IPAddress ip(192, 168, 1, 100);        // IP da mÃ¡quina
IPAddress server(192, 168, 1, 150);    // â† IP DO SEU CELULAR AQUI!
EthernetClient ethClient;

// ==================== OBJETOS ====================
MFRC522 mfrc522(SS_RFID_PIN, RST_PIN);
BLEScan* pBLEScan;
BLEClient* pClient = nullptr;
BLEAdvertisedDevice* myDevice = nullptr;

// ==================== ESTADOS DO SISTEMA ====================
enum Estado {
  STANDBY,
  AUTENTICANDO,
  PAREANDO_BLE,
  OPERANDO,
  ALERTANDO,
  DESLIGANDO
};

Estado estadoAtual = STANDBY;

// ==================== VARIÃVEIS GLOBAIS ====================
String uidAtual = "";
String nomeUsuario = "";
String cargoUsuario = "";
bool bleConectado = false;
unsigned long ultimaVerificacaoRSSI = 0;
unsigned long tempoInicioOperacao = 0;

// ==================== USUÃRIOS AUTORIZADOS (OFFLINE) ====================
struct Usuario {
  String uid;
  String nome;
  String cargo;
  bool ativo;
};

Usuario usuariosAutorizados[] = {
  {"FA089CBC", "JoÃ£o Silva", "Operador Senior", true},
  {"EBEABCA5", "Maria Santos", "Supervisora", true},
  {"6B423203", "Pedro Costa", "TÃ©cnico", true},
  {"FB32FAA5", "Ana Oliveira", "Operadora", true},
  {"AA5C15BC", "Carlos Souza", "MecÃ¢nico", true},
  {"F1B2715B", "Lucas Ferreira", "Auxiliar", true}
};
const int numUsuarios = 6;

// ==================== DECLARAÃ‡ÃƒO DE FUNÃ‡Ã•ES ====================
void beep(int vezes);
void enviarLog(String evento, String uid, String usuario, unsigned long duracao = 0);

// ==================== CALLBACK BLE ====================
class MyAdvertisedDeviceCallbacks: public BLEAdvertisedDeviceCallbacks {
  void onResult(BLEAdvertisedDevice advertisedDevice) {
    // NÃ£o usar mais callback, processar manualmente
  }
};

// ==================== SETUP ====================
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘  SISTEMA DE CONTROLE DE ACESSO v1.1              â•‘");
  Serial.println("â•‘        Iniciando componentes...                   â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  // Configurar pinos
  pinMode(LED_RED, OUTPUT);
  pinMode(LED_GREEN, OUTPUT);
  pinMode(BUZZER, OUTPUT);
  pinMode(RELAY, OUTPUT);
  
  digitalWrite(LED_RED, LOW);
  digitalWrite(LED_GREEN, HIGH);
  digitalWrite(RELAY, LOW);
  
  // Inicializar SPI
  SPI.begin(SCK_PIN, MISO_PIN, MOSI_PIN);
  
  // Inicializar RC522
  Serial.print("ğŸ” Inicializando RC522... ");
  pinMode(SS_RFID_PIN, OUTPUT);
  digitalWrite(SS_RFID_PIN, HIGH);
  pinMode(RST_PIN, OUTPUT);
  digitalWrite(RST_PIN, LOW);
  delay(100);
  digitalWrite(RST_PIN, HIGH);
  delay(100);
  
  mfrc522.PCD_Init();
  delay(100);
  
  byte version = mfrc522.PCD_ReadRegister(mfrc522.VersionReg);
  if (version == 0x00 || version == 0xFF) {
    Serial.println("âŒ FALHA!");
    while(1) { beep(3); delay(1000); }
  }
  Serial.print("âœ… OK (v0x");
  Serial.print(version, HEX);
  Serial.println(")");
  
  // Inicializar Ethernet
  Serial.print("ğŸŒ Inicializando Ethernet... ");
  pinMode(SS_ETH_PIN, OUTPUT);
  digitalWrite(SS_ETH_PIN, HIGH);
  pinMode(ETH_RST_PIN, OUTPUT);
  digitalWrite(ETH_RST_PIN, LOW);
  delay(100);
  digitalWrite(ETH_RST_PIN, HIGH);
  delay(500);
  
  Ethernet.init(SS_ETH_PIN);
  
  if (Ethernet.begin(mac, 5000) == 0) {
    Serial.println("âš ï¸  DHCP falhou, usando IP estÃ¡tico");
    Ethernet.begin(mac, ip);
  }
  
  if (Ethernet.hardwareStatus() == EthernetNoHardware) {
    Serial.println("âš ï¸  W5500 nÃ£o detectado");
  } else {
    Serial.print("âœ… OK (IP: ");
    Serial.print(Ethernet.localIP());
    Serial.println(")");
  }
  
  // Inicializar BLE
  Serial.print("ğŸ“¡ Inicializando BLE... ");
  BLEDevice::init("ControleAcesso-ESP32");
  
  // âœ… AUMENTAR POTÃŠNCIA TX
  esp_ble_tx_power_set(ESP_BLE_PWR_TYPE_ADV, ESP_PWR_LVL_P9);
  esp_ble_tx_power_set(ESP_BLE_PWR_TYPE_SCAN, ESP_PWR_LVL_P9);
  esp_ble_tx_power_set(ESP_BLE_PWR_TYPE_DEFAULT, ESP_PWR_LVL_P9);
  
  pBLEScan = BLEDevice::getScan();
  pBLEScan->setAdvertisedDeviceCallbacks(new MyAdvertisedDeviceCallbacks());
  pBLEScan->setActiveScan(true);
  pBLEScan->setInterval(100);
  pBLEScan->setWindow(99);
  Serial.println("âœ… OK (+9dBm)");
  
  beep(1);
  Serial.println("\nâœ… Sistema pronto! Aguardando cartÃ£o RFID...\n");
  estadoAtual = STANDBY;
}

// ==================== LOOP PRINCIPAL ====================
void loop() {
  switch(estadoAtual) {
    case STANDBY:
      loopStandby();
      break;
    case AUTENTICANDO:
      loopAutenticando();
      break;
    case PAREANDO_BLE:
      loopPareandoBLE();
      break;
    case OPERANDO:
      loopOperando();
      break;
    case ALERTANDO:
      loopAlertando();
      break;
    case DESLIGANDO:
      loopDesligando();
      break;
  }
  delay(100);
}

// ==================== STANDBY ====================
void loopStandby() {
  digitalWrite(LED_RED, LOW);
  digitalWrite(LED_GREEN, HIGH);
  digitalWrite(RELAY, LOW);
  
  if (!mfrc522.PICC_IsNewCardPresent()) return;
  if (!mfrc522.PICC_ReadCardSerial()) return;
  
  uidAtual = "";
  for (byte i = 0; i < mfrc522.uid.size; i++) {
    uidAtual += String(mfrc522.uid.uidByte[i] < 0x10 ? "0" : "");
    uidAtual += String(mfrc522.uid.uidByte[i], HEX);
  }
  uidAtual.toUpperCase();
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.print("â•‘  ğŸ”– CartÃ£o: ");
  Serial.print(uidAtual);
  int esp = 36 - uidAtual.length();
  for(int i=0; i<esp; i++) Serial.print(" ");
  Serial.println("â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  beep(1);
  mfrc522.PICC_HaltA();
  estadoAtual = AUTENTICANDO;
}

// ==================== AUTENTICANDO ====================
void loopAutenticando() {
  Serial.println("ğŸ” Validando usuÃ¡rio...");
  
  bool autorizado = false;
  for (int i = 0; i < numUsuarios; i++) {
    if (usuariosAutorizados[i].uid == uidAtual && usuariosAutorizados[i].ativo) {
      autorizado = true;
      nomeUsuario = usuariosAutorizados[i].nome;
      cargoUsuario = usuariosAutorizados[i].cargo;
      break;
    }
  }
  
  if (autorizado) {
    Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    Serial.println("â”‚ âœ… ACESSO AUTORIZADO                               â”‚");
    Serial.print("â”‚ Nome: ");
    Serial.print(nomeUsuario);
    for(int i=0; i<(44-nomeUsuario.length()); i++) Serial.print(" ");
    Serial.println("â”‚");
    Serial.print("â”‚ Cargo: ");
    Serial.print(cargoUsuario);
    for(int i=0; i<(43-cargoUsuario.length()); i++) Serial.print(" ");
    Serial.println("â”‚");
    Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
    
    enviarLog("AUTENTICADO", uidAtual, nomeUsuario);
    estadoAtual = PAREANDO_BLE;
  } else {
    Serial.println("âŒ ACESSO NEGADO - CartÃ£o nÃ£o cadastrado");
    beep(3);
    enviarLog("ACESSO_NEGADO", uidAtual, "Desconhecido");
    delay(2000);
    uidAtual = "";
    nomeUsuario = "";
    estadoAtual = STANDBY;
  }
}

// ==================== PAREANDO BLE (CORRIGIDO) ====================
void loopPareandoBLE() {
  Serial.println("\nğŸ“¡ Procurando dispositivo BLE...");
  
  myDevice = nullptr;
  pBLEScan->clearResults();
  
  // âœ… CORREÃ‡ÃƒO: Usar ponteiro
  BLEScanResults* foundDevices = pBLEScan->start(5, false);
  
  // âœ… PROCESSAR MANUALMENTE
  int count = foundDevices->getCount();
  Serial.print("ğŸ“Š Dispositivos encontrados: ");
  Serial.println(count);
  
  if (count > 0) {
    Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    for (int i = 0; i < count; i++) {
      BLEAdvertisedDevice device = foundDevices->getDevice(i);
      String nome = device.getName().c_str();
      int rssi = device.getRSSI();
      
      Serial.print("â”‚ ");
      Serial.print(nome.length() > 0 ? nome : "(sem nome)");
      Serial.print(" â†’ ");
      Serial.print(rssi);
      Serial.println(" dBm");
      
      // âœ… BUSCAR PELO NOME
      if (nome == BLE_DEVICE_NAME) {
        Serial.println("â”‚   âœ… ESTE Ã‰ O NOSSO CARTÃƒO!");
        myDevice = new BLEAdvertisedDevice(device);
      }
    }
    Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
  }
  
  pBLEScan->clearResults();
  
  if (myDevice == nullptr) {
    Serial.println("\nâŒ CartaoAcesso nÃ£o encontrado!");
    Serial.println("   Verifique:");
    Serial.println("   - ESP32-C3 estÃ¡ ligado?");
    Serial.println("   - CÃ³digo BLE carregado no C3?");
    Serial.println("   - DistÃ¢ncia < 5 metros?");
    beep(3);
    enviarLog("BLE_NAO_ENCONTRADO", uidAtual, nomeUsuario);
    delay(2000);
    estadoAtual = STANDBY;
    return;
  }
  
  Serial.println("\nğŸ”— Conectando...");
  pClient = BLEDevice::createClient();
  
  if (!pClient->connect(myDevice)) {
    Serial.println("âŒ Falha ao conectar!");
    beep(3);
    delete pClient;
    pClient = nullptr;
    estadoAtual = STANDBY;
    return;
  }
  
  bleConectado = true;
  digitalWrite(RELAY, HIGH);
  digitalWrite(LED_RED, HIGH);
  digitalWrite(LED_GREEN, LOW);
  beep(2);
  
  tempoInicioOperacao = millis();
  enviarLog("MAQUINA_LIGADA", uidAtual, nomeUsuario);
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘         âœ… BLE CONECTADO COM SUCESSO! âœ…           â•‘");
  Serial.println("â•‘      Monitorando proximidade via RSSI...          â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  estadoAtual = OPERANDO;
}

// ==================== OPERANDO ====================
void loopOperando() {
  if (!pClient->isConnected()) {
    Serial.println("\nâš ï¸  ConexÃ£o BLE perdida!");
    estadoAtual = DESLIGANDO;
    return;
  }
  
  if (millis() - ultimaVerificacaoRSSI >= RSSI_CHECK_INTERVAL) {
    int rssi = pClient->getRssi();
    
    Serial.print("ğŸ“¶ RSSI: ");
    if(rssi > -100) Serial.print(" ");
    if(rssi > -10) Serial.print(" ");
    Serial.print(rssi);
    Serial.print(" dBm  ");
    
    // Barra visual
    int barras = map(rssi, -100, -50, 0, 10);
    barras = constrain(barras, 0, 10);
    Serial.print("[");
    for(int i=0; i<10; i++) {
      if(i < barras) Serial.print("â–ˆ");
      else Serial.print("â–‘");
    }
    Serial.print("]  ");
    
    if (rssi > -60) {
      Serial.println("Muito prÃ³ximo (<1m) âœ…");
    } else if (rssi > -70) {
      Serial.println("PrÃ³ximo (~2m) âœ…");
    } else if (rssi > RSSI_THRESHOLD_WARNING) {
      Serial.println("Normal (~2-2.5m) âœ…");
    } else if (rssi > RSSI_THRESHOLD_CRITICAL) {
      Serial.println("Distante (~2.5m) âš ï¸");
      estadoAtual = ALERTANDO;
      return;
    } else {
      Serial.println("CRÃTICO (>3m) ğŸš¨");
      estadoAtual = DESLIGANDO;
      return;
    }
    
    ultimaVerificacaoRSSI = millis();
  }
}

// ==================== ALERTANDO ====================
void loopAlertando() {
  static unsigned long tempoAlerta = 0;
  
  if (tempoAlerta == 0) {
    tempoAlerta = millis();
    Serial.println("\nâš ï¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Serial.println("âš ï¸  ALERTA: UsuÃ¡rio se afastando!");
    Serial.println("âš ï¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    beep(1);
  }
  
  // LED amarelo piscando
  if (millis() % 500 < 250) {
    digitalWrite(LED_RED, LOW);
    digitalWrite(LED_GREEN, LOW);
  } else {
    digitalWrite(LED_RED, HIGH);
    digitalWrite(LED_GREEN, HIGH);
  }
  
  if (!pClient->isConnected()) {
    estadoAtual = DESLIGANDO;
    return;
  }
  
  int rssi = pClient->getRssi();
  
  if (rssi > RSSI_THRESHOLD_WARNING) {
    Serial.println("âœ… Retornou Ã  distÃ¢ncia segura\n");
    tempoAlerta = 0;
    digitalWrite(LED_GREEN, LOW);
    estadoAtual = OPERANDO;
  } else if (rssi < RSSI_THRESHOLD_CRITICAL) {
    Serial.println("ğŸš¨ DistÃ¢ncia crÃ­tica!");
    estadoAtual = DESLIGANDO;
  }
  
  if (millis() - tempoAlerta > 10000) {
    Serial.println("â±ï¸  Timeout - desligando");
    estadoAtual = DESLIGANDO;
  }
}

// ==================== DESLIGANDO ====================
void loopDesligando() {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘              ğŸš¨ ENCERRANDO SESSÃƒO ğŸš¨              â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  digitalWrite(RELAY, LOW);
  digitalWrite(LED_RED, LOW);
  digitalWrite(LED_GREEN, HIGH);
  beep(3);
  
  unsigned long duracaoSegundos = (millis() - tempoInicioOperacao) / 1000;
  
  Serial.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
  Serial.print("â”‚ â±ï¸  DuraÃ§Ã£o: ");
  Serial.print(duracaoSegundos / 60);
  Serial.print(" min ");
  Serial.print(duracaoSegundos % 60);
  Serial.println(" seg                                â”‚");
  Serial.print("â”‚ ğŸ‘¤ UsuÃ¡rio: ");
  Serial.print(nomeUsuario);
  for(int i=0; i<(38-nomeUsuario.length()); i++) Serial.print(" ");
  Serial.println("â”‚");
  Serial.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
  
  enviarLog("MAQUINA_DESLIGADA", uidAtual, nomeUsuario, duracaoSegundos);
  
  if (pClient != nullptr && pClient->isConnected()) {
    pClient->disconnect();
  }
  
  bleConectado = false;
  uidAtual = "";
  nomeUsuario = "";
  cargoUsuario = "";
  
  Serial.println("\nâœ… Aguardando novo cartÃ£o...\n");
  delay(2000);
  estadoAtual = STANDBY;
}

// ==================== FUNÃ‡Ã•ES AUXILIARES ====================

void beep(int vezes) {
  for (int i = 0; i < vezes; i++) {
    digitalWrite(BUZZER, HIGH);
    delay(100);
    digitalWrite(BUZZER, LOW);
    delay(100);
  }
}

void enviarLog(String evento, String uid, String usuario, unsigned long duracao) {
  Serial.print("ğŸ“ Log: ");
  Serial.print(evento);
  Serial.print(" | ");
  Serial.println(usuario);
  
  if (Ethernet.hardwareStatus() == EthernetNoHardware) {
    Serial.println("   âš ï¸  Sem Ethernet");
    return;
  }
  
  StaticJsonDocument<256> doc;
  doc["timestamp"] = millis() / 1000;
  doc["machine_id"] = "DEMO-01";
  doc["uid"] = uid;
  doc["usuario"] = usuario;
  doc["evento"] = evento;
  doc["duracao"] = duracao;
  
  String json;
  serializeJson(doc, json);
  
  if (ethClient.connect(server, 3000)) {
    ethClient.println("POST /api/log HTTP/1.1");
    ethClient.print("Host: ");
    ethClient.println(server);
    ethClient.println("Content-Type: application/json");
    ethClient.print("Content-Length: ");
    ethClient.println(json.length());
    ethClient.println();
    ethClient.println(json);
    ethClient.stop();
    Serial.println("   âœ… Enviado ao servidor");
  } else {
    Serial.println("   âŒ Servidor offline");
  }
}

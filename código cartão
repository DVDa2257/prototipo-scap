/*
 * CARTÃO BLE - MÁXIMA POTÊNCIA E ALCANCE
 */

#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>

#define DEVICE_NAME "CartaoAcesso"
#define LED_PIN 8

BLEServer* pServer = NULL;
bool deviceConnected = false;

class ServerCallbacks: public BLEServerCallbacks {
  void onConnect(BLEServer* pServer) {
    deviceConnected = true;
    digitalWrite(LED_PIN, HIGH);
    Serial.println("✅ Conectado!");
  }

  void onDisconnect(BLEServer* pServer) {
    deviceConnected = false;
    digitalWrite(LED_PIN, LOW);
    Serial.println("❌ Desconectado");
    delay(500);
    pServer->startAdvertising();
  }
};

void setup() {
  Serial.begin(115200);
  delay(2000);
  
  Serial.println("\n╔════════════════════════════════════╗");
  Serial.println("║ CARTÃO BLE - MÁXIMA POTÊNCIA       ║");
  Serial.println("╚════════════════════════════════════╝\n");
  
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);
  
  BLEDevice::init(DEVICE_NAME);
  
  // MÁXIMA POTÊNCIA
  esp_ble_tx_power_set(ESP_BLE_PWR_TYPE_ADV, ESP_PWR_LVL_P9);
  esp_ble_tx_power_set(ESP_BLE_PWR_TYPE_CONN_HDL0, ESP_PWR_LVL_P9);
  esp_ble_tx_power_set(ESP_BLE_PWR_TYPE_CONN_HDL1, ESP_PWR_LVL_P9);
  esp_ble_tx_power_set(ESP_BLE_PWR_TYPE_DEFAULT, ESP_PWR_LVL_P9);
  
  Serial.println("⚡ Potência: +9 dBm (20-30m)");
  
  pServer = BLEDevice::createServer();
  pServer->setCallbacks(new ServerCallbacks());
  
  BLEService *pService = pServer->createService(BLEUUID((uint16_t)0x180A));
  
  BLECharacteristic *pChar = pService->createCharacteristic(
    BLEUUID((uint16_t)0x2A57),
    BLECharacteristic::PROPERTY_READ | 
    BLECharacteristic::PROPERTY_NOTIFY |
    BLECharacteristic::PROPERTY_WRITE
  );
  
  pChar->addDescriptor(new BLE2902());
  pChar->setValue("OK");
  
  pService->start();
  
  BLEAdvertising *pAdvertising = BLEDevice::getAdvertising();
  pAdvertising->addServiceUUID(pService->getUUID());
  pAdvertising->setScanResponse(true);
  pAdvertising->setMinInterval(0x20);
  pAdvertising->setMaxInterval(0x40);
  pAdvertising->setMinPreferred(0x06);
  pAdvertising->setMinPreferred(0x12);
  
  BLEDevice::startAdvertising();
  
  Serial.println("✅ Aguardando conexão...\n");
  
  for(int i=0; i<3; i++) {
    digitalWrite(LED_PIN, HIGH);
    delay(200);
    digitalWrite(LED_PIN, LOW);
    delay(200);
  }
}

void loop() {
  if (!deviceConnected) {
    static unsigned long last = 0;
    if (millis() - last > 2000) {
      digitalWrite(LED_PIN, !digitalRead(LED_PIN));
      last = millis();
    }
  }
  delay(100);
}

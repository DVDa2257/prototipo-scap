/*
===============================================================================
  DEMO APRESENTAÃ‡ÃƒO - SISTEMA DE CONTROLE DE ACESSO
  
  VERSÃƒO SIMPLIFICADA PARA DEMONSTRAÃ‡ÃƒO
  
  Funcionalidades:
  âœ… Leitura RFID
  âœ… ConexÃ£o BLE
  âœ… Monitoramento RSSI/DistÃ¢ncia
  âœ… Controle RelÃ©
  âœ… Feedback visual (LEDs)
  âœ… Logs Ethernet
  
  Pinagem:
  RC522:  RSTâ†’0, SDAâ†’1, MOSIâ†’6, MISOâ†’5, SCKâ†’4
  W5500:  RSTâ†’2, CSâ†’3, MOSIâ†’6, MISOâ†’5, SCKâ†’4
  LED:    REDâ†’7, GREENâ†’8
  Buzzer: â†’9
  RelÃ©:   â†’10
===============================================================================
*/

#include <SPI.h>
#include <MFRC522.h>
#include <Ethernet.h>
#include "BLEDevice.h"

// ===== PINOS =====
#define RST_PIN_RFID    0
#define SS_PIN_RFID     1
#define RST_PIN_ETH     2
#define SS_PIN_ETH      3
#define LED_RED         7
#define LED_GREEN       8
#define BUZZER          9
#define RELE           10

// ===== CONFIGURAÃ‡Ã•ES =====
#define CARD_BLE_NAME   "CartaoAcesso"
#define RSSI_LIMITE     -85  // DistÃ¢ncia crÃ­tica

// ===== OBJETOS =====
MFRC522 rfid(SS_PIN_RFID, RST_PIN_RFID);
byte mac[] = {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED};

// ===== VARIÃVEIS =====
bool sistemaOK = false;
bool maquinaLigada = false;
BLEClient* bleClient = NULL;
String usuarioAtual = "";
unsigned long inicioSessao = 0;

// UsuÃ¡rios autorizados
String usuarios[] = {"F1B2715B", "04A1B2C3"};
int numUsuarios = 2;

// ===== DECLARAÃ‡Ã•ES ANTECIPADAS =====
void setLED(bool red, bool green);
void beep(int count);
void pararMaquina(String motivo);
void ligarMaquina();
bool procurarBLE();

// ===== CALLBACKS BLE =====
class ClientCallback : public BLEClientCallbacks {
  void onDisconnect(BLEClient* p) {
    if (maquinaLigada) {
      Serial.println("BLE desconectado - parando mÃ¡quina");
      pararMaquina("CONEXAO_PERDIDA");
    }
  }
};

// ===== DECLARAÃ‡Ã•ES =====
void setLED(bool red, bool green);
void beep(int count);
void pararMaquina(String motivo);

void setup() {
  Serial.begin(115200);
  delay(2000);
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘  DEMO - CONTROLE DE ACESSO         â•‘");
  Serial.println("â•‘  VersÃ£o ApresentaÃ§Ã£o               â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  // Configurar pinos
  pinMode(LED_RED, OUTPUT);
  pinMode(LED_GREEN, OUTPUT);
  pinMode(BUZZER, OUTPUT);
  pinMode(RELE, OUTPUT);
  
  setLED(true, false);  // Vermelho inicial
  digitalWrite(RELE, LOW);
  
  Serial.println("âš™ï¸  Iniciando sistema...\n");
  
  // ===== RFID =====
  Serial.print("ğŸ“¡ RFID RC522... ");
  SPI.begin();
  rfid.PCD_Init();
  byte version = rfid.PCD_ReadRegister(rfid.VersionReg);
  
  if (version == 0x91 || version == 0x92) {
    Serial.printf("OK (v0x%02X)\n", version);
  } else {
    Serial.println("ERRO!");
    while(1) {
      setLED(true, true);
      delay(200);
      setLED(false, false);
      delay(200);
    }
  }
  
  // ===== ETHERNET =====
  Serial.print(" Ethernet W5500... ");
  pinMode(RST_PIN_ETH, OUTPUT);
  digitalWrite(RST_PIN_ETH, LOW);
  delay(10);
  digitalWrite(RST_PIN_ETH, HIGH);
  delay(100);
  
  Ethernet.init(SS_PIN_ETH);
  
  if (Ethernet.begin(mac, 5000)) {
    Serial.print("OK (IP: ");
    Serial.print(Ethernet.localIP());
    Serial.println(")");
  } else {
    Serial.println("Offline (continuando...)");
  }
  
  // ===== BLE =====
  Serial.print(" Bluetooth BLE... ");
  BLEDevice::init("DemoMaquina");
  Serial.println("OK");
  
  // ===== PRONTO =====
  sistemaOK = true;
  setLED(false, true);
  beep(2);
  delay(1000);
  setLED(true, false);
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘  âœ… SISTEMA PRONTO!                â•‘");
  Serial.println("â•‘                                    â•‘");
  Serial.println("â•‘   Aproxime um cartÃ£o RFID        â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void loop() {
  // ===== VERIFICAR CARTÃƒO RFID =====
  if (!maquinaLigada && rfid.PICC_IsNewCardPresent() && rfid.PICC_ReadCardSerial()) {
    
    // Ler UID
    String uid = "";
    for (byte i = 0; i < rfid.uid.size; i++) {
      uid += String(rfid.uid.uidByte[i] < 0x10 ? "0" : "");
      uid += String(rfid.uid.uidByte[i], HEX);
    }
    uid.toUpperCase();
    
    Serial.println("\n" + String('â”€', 40));
    Serial.printf(" CARTÃƒO: %s\n", uid.c_str());
    
    // Verificar autorizaÃ§Ã£o
    bool autorizado = false;
    for (int i = 0; i < numUsuarios; i++) {
      if (usuarios[i] == uid) {
        autorizado = true;
        break;
      }
    }
    
    if (autorizado) {
      Serial.println("âœ… AUTORIZADO!");
      usuarioAtual = uid;
      
      // Feedback
      setLED(false, true);
      beep(2);
      
      // Procurar BLE
      Serial.println("\nğŸ” Procurando cartÃ£o BLE...");
      if (procurarBLE()) {
        ligarMaquina();
      } else {
        Serial.println("âš ï¸  CartÃ£o BLE nÃ£o encontrado");
        setLED(true, false);
        beep(3);
      }
      
    } else {
      Serial.println("âŒ ACESSO NEGADO!");
      setLED(true, false);
      beep(3);
      delay(2000);
    }
    
    Serial.println(String('â”€', 40) + "\n");
    
    rfid.PICC_HaltA();
    rfid.PCD_StopCrypto1();
  }
  
  // ===== MONITORAR DISTÃ‚NCIA =====
  if (maquinaLigada) {
    static unsigned long ultimaVerificacao = 0;
    
    if (millis() - ultimaVerificacao > 2000) {
      ultimaVerificacao = millis();
      
      if (bleClient && bleClient->isConnected()) {
        int rssi = bleClient->getRssi();
        
        // Calcular distÃ¢ncia aproximada
        String status = "";
        if (rssi > -60) status = "MUITO PRÃ“XIMO";
        else if (rssi > -70) status = "PRÃ“XIMO";
        else if (rssi > -80) status = "NORMAL";
        else if (rssi > RSSI_LIMITE) status = "âš ï¸  DISTANTE";
        else status = "ğŸš¨ CRÃTICO";
        
        Serial.printf(" RSSI: %d dBm | Status: %s\n", rssi, status.c_str());
        
        // Piscar verde = monitorando
        setLED(false, false);
        delay(50);
        setLED(false, true);
        
        // Verificar distÃ¢ncia crÃ­tica
        if (rssi < RSSI_LIMITE) {
          Serial.println("\nğŸš¨ DISTÃ‚NCIA CRÃTICA DETECTADA!");
          pararMaquina("USUARIO_DISTANTE");
        }
        
      } else {
        Serial.println("âš ï¸  ConexÃ£o BLE perdida");
        pararMaquina("CONEXAO_PERDIDA");
      }
    }
    
    // Timeout 5 minutos
    if (millis() - inicioSessao > 300000) {
      Serial.println("\n Timeout de sessÃ£o");
      pararMaquina("TIMEOUT");
    }
  }
  
  delay(100);
}

// ========================================
// FUNÃ‡Ã•ES
// ========================================

bool procurarBLE() {
  BLEScan* scan = BLEDevice::getScan();
  scan->setActiveScan(true);
  BLEScanResults* results = scan->start(5, false);
  
  Serial.printf("   Dispositivos encontrados: %d\n", results->getCount());
  
  for (int i = 0; i < results->getCount(); i++) {
    BLEAdvertisedDevice device = results->getDevice(i);
    
    Serial.printf("   [%d] %s (RSSI: %d)\n", 
                  i+1, 
                  device.getName().c_str(), 
                  device.getRSSI());
    
    if (device.getName() == CARD_BLE_NAME) {
      Serial.println("\n CartÃ£o encontrado!");
      
      bleClient = BLEDevice::createClient();
      bleClient->setClientCallbacks(new ClientCallback());
      
      if (bleClient->connect(&device)) {
        Serial.println("âœ… BLE conectado!");
        scan->clearResults();
        return true;
      }
    }
  }
  
  scan->clearResults();
  return false;
}

void ligarMaquina() {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘  âš¡ MÃQUINA LIGADA                 â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  digitalWrite(RELE, HIGH);
  maquinaLigada = true;
  inicioSessao = millis();
  setLED(false, true);
  
  Serial.printf("\nğŸ‘¤ UsuÃ¡rio: %s\n", usuarioAtual.c_str());
  Serial.println("ğŸ“¡ Monitorando proximidade...\n");
}

void pararMaquina(String motivo) {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.printf("â•‘  â¹ï¸  MÃQUINA PARADA                â•‘\n");
  Serial.printf("â•‘  Motivo: %-24s â•‘\n", motivo.c_str());
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  digitalWrite(RELE, LOW);
  maquinaLigada = false;
  
  if (bleClient && bleClient->isConnected()) {
    bleClient->disconnect();
  }
  bleClient = NULL;
  
  unsigned long duracao = (millis() - inicioSessao) / 1000;
  Serial.printf("â±ï¸  DuraÃ§Ã£o da sessÃ£o: %lu segundos\n\n", duracao);
  
  setLED(true, false);
  beep(1);
  
  usuarioAtual = "";
  inicioSessao = 0;
  
  Serial.println("ğŸ‘‰ Aguardando prÃ³ximo cartÃ£o...\n");
}

void setLED(bool red, bool green) {
  digitalWrite(LED_RED, red ? LOW : HIGH);
  digitalWrite(LED_GREEN, green ? LOW : HIGH);
}

void beep(int count) {
  for (int i = 0; i < count; i++) {
    digitalWrite(BUZZER, HIGH);
    delay(150);
    digitalWrite(BUZZER, LOW);
    delay(150);
  }
}
